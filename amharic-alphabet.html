<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>áŠ áˆ›áˆ­áŠ› áŠá‹°áˆ Fun</title>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Ethiopic&display=swap" rel="stylesheet">
    <style>
        /* Restored Original Theme and Structure */
        :root{
            --accent:#ff6f61; --accent2:#ffa500; --bg:#f0f8ff; --card:#fff; --muted:#555;
            --success:#28a745; --fail:#dc3545;
        }
        body{margin:0;font-family:"Noto Sans Ethiopic",sans-serif;background:var(--bg);color:#222;}
        header{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;padding:14px 12px;position:sticky;top:0;z-index:50;}
        .top-row{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;max-width:1200px;margin:0 auto;}

        nav{display:flex;gap:8px;flex-wrap:wrap;}
        nav button{background:#fff;border:none;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600;color:var(--accent);}
        nav button.active{background:rgba(255,255,255,0.2);color:#fff;}
        .toggles{display:flex;gap:8px;}
        .toggles button{background:#fff;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;}
        main{max-width:1200px;margin:18px auto;padding:0 12px;}
        .section{display:none;}
        .section.active{display:block;}
        .letters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px}
        .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 6px 12px rgba(0,0,0,0.06);text-align:center;transition:transform .18s;cursor:default;}
        .card:hover{transform:translateY(-4px);}
        .base-letter{font-size:44px;font-weight:700;color:var(--accent);}
        .orders{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:6px}
        .order{background:#f6f0ff;padding:6px 8px;border-radius:8px;cursor:pointer;border:1px solid rgba(255,111,97,0.3);}
        .word{margin-top:8px;font-weight:700;color:#333;cursor:pointer;}
        .sentence{font-size:14px;color:var(--muted);margin-top:6px;}
        .high-contrast{background:#000;color:#ffeb3b}
        .large-text{font-size:1.25rem}
        canvas#effectsCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:1200}
        .game-container{margin-top:16px;text-align:center;}
        .game-btn{padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;font-weight:700;margin:6px;cursor:pointer;}
        .option-btn{padding:10px 14px;border-radius:10px;border:2px solid var(--accent2);cursor:pointer;min-width:110px;margin:4px;}
        .option-btn.correct{background:var(--success);color:#fff;border-color:var(--success);}
        .option-btn.wrong{background:var(--fail);border-color:var(--fail);color:#fff;}
        .emoji-feedback{font-size:2rem;animation: bounce 0.6s;}
        @keyframes bounce{0%{transform:scale(1)}50%{transform:scale(1.5)}100%{transform:scale(1)}}

        /* --- Memory Game Styles --- */
        .memory-game-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            max-width: 600px;
            margin: 20px auto;
            perspective: 1000px;
        }
        .memory-card {
            background-color: transparent;
            width: 100%;
            aspect-ratio: 1 / 1;
            border-radius: 10px;
            cursor: pointer;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }
        .memory-card.flipped {
            transform: rotateY(180deg);
        }
        .memory-card .front-face,
        .memory-card .back-face {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 10px;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 3rem;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .memory-card .front-face {
            background: linear-gradient(45deg, var(--accent), var(--accent2));
            color: white;
        }
        .memory-card .front-face::after {
            content: '?';
            font-size: 4rem;
        }
        .memory-card .back-face {
            background-color: var(--card);
            color: var(--accent);
            transform: rotateY(180deg);
        }
        /* --- Word Pop-up Styles --- */
        #word-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--success);
            color: white;
            padding: 30px 50px;
            border-radius: 25px;
            font-size: 4rem;
            font-weight: 700;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 2000;
            animation: popup-animation 0.5s ease-out forwards;
            pointer-events: none;
        }
        #word-popup.hidden {
            display: none;
        }
        @keyframes popup-animation {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }
        /* --- TTS Status Box --- */
        #status-box {
            background-color: #ffeaea; /* Light Red/Error Color */
            border: 1px solid #ff0000;
            color: #8b0000;
            padding: 10px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none; /* Controlled by JS */
        }
        #status-box.active {
            display: block;
        }
    </style>
</head>
<body>

<header>
    <div class="top-row">
        <div class="brand">ğŸ‰ áŠ áˆ›áˆ­áŠ› áŠá‹°áˆ Fun</div>

        <nav>
            <button data-section="letters" class="active">Letters</button>
            <button data-section="mini">Mini Games</button>
            <button data-section="quiz">Quiz</button>
        </nav>
        <div class="toggles">
            <button id="contrastBtn">ğŸŒ“ Contrast</button>
            <button id="textBtn">ğŸ”  Large Text</button>
        </div>
    </div>
</header>

<main>
    <div id="status-box">
        <strong id="status-message"></strong>
    </div>

    <section id="letters" class="section active">
        <h2>ğŸ“š Letters & Words</h2>
        <div class="letters-grid" id="lettersGrid"></div>
    </section>

    <section id="mini" class="section">
        <h2>ğŸ® Mini Games</h2>
        <div class="game-container">
            <button class="game-btn" onclick="startMatchingGame()">ğŸ§  Memory Match</button>
            <button class="game-btn" onclick="startTraceGame()">âœï¸ Trace Letter</button>
            <div id="gameArea"></div>
        </div>
    </section>

    <section id="quiz" class="section">
        <h2>ğŸ¯ Quiz</h2>
        <div id="quizArea"></div>
        <div id="emojiFeedback" class="emoji-feedback"></div>
        <p>Score: <span id="score">0</span></p>
    </section>
</main>

<canvas id="effectsCanvas"></canvas>
<div id="word-popup" class="hidden"></div>
<audio id="audio-player" hidden></audio>

<script>
    // ---------------- Letters Data ----------------
    // Data is preserved from the original file
    const lettersData=[{base:"áˆ€",orders:["áˆ€","áˆ","áˆ‚","áˆƒ","áˆ„","áˆ…","áˆ†"],word:"áˆ€á‰¥á‰µ",sentence:"áˆ€á‰¥á‰µ á‰ áˆ¥áˆ« á‹­áˆ˜áŒ£áˆ"},{base:"áˆˆ",orders:["áˆˆ","áˆ‰","áˆŠ","áˆ‹", "áˆŒ", "áˆ", "áˆ"],word:"áˆáˆš",sentence:"áˆáˆš áŒáˆá‹›á‹› áŠá‹"},{base:"áˆ",orders:["áˆ","áˆ‘","áˆ’","áˆ“","áˆ”","áˆ•","áˆ–"],word:"áˆáŠªáˆ",sentence:"áˆáŠªáˆ™ á‰³áŠ«áˆšá‹áŠ• á‹­áˆ¨á‹³áˆ"},{base:"áˆ˜",orders:["áˆ˜","áˆ™","áˆš","áˆ›","áˆœ","áˆ","áˆ"],word:"áˆ˜áŠªáŠ“",sentence:"áˆ˜áŠªáŠ“á‹ á‰ ááŒ¥áŠá‰µ á‹­áŒ“á‹›áˆ"},{base:"áˆ ",orders:["áˆ ","áˆ¡","áˆ¢","áˆ£","áˆ¤","áˆ¥","áˆ¦"],word:"áˆ áˆ‹áˆ",sentence:"áˆ áˆ‹áˆ áˆˆáˆáˆ‰áˆ"},{base:"áˆ¨",orders:["áˆ¨","áˆ©","áˆª","áˆ«","áˆ¬","áˆ­","áˆ®"],word:"áˆ¬á‹²á‹®",sentence:"áˆ¬á‹²á‹® áˆ™á‹šá‰ƒ á‹«áŒ«á‹á‰³áˆ"},{base:"áˆ°",orders:["áˆ°","áˆ±","áˆ²","áˆ³","áˆ´","áˆµ","áˆ¶"],word:"áˆ°á‹“á‰µ",sentence:"áˆ°á‹“á‰± á‰µáŠ­áŠ­áˆˆáŠ› áŠá‹"},{base:"áˆ¸",orders:["áˆ¸","áˆ¹","áˆº","áˆ»","áˆ¼","áˆ½","áˆ¾"],word:"áˆ¸áˆšá‹",sentence:"áˆ¸áˆšá‹™ áŠ•áŒ¹áˆ… áŠá‹"},{base:"á‰€",orders:["á‰€","á‰","á‰‚","á‰ƒ","á‰„","á‰…","á‰†"],word:"á‰€áˆˆáˆ",sentence:"á‰€áˆˆáˆ™ á‹°áˆ›á‰… áŠá‹"},{base:"á‰ ",orders:["á‰ ","á‰¡","á‰¢","á‰£","á‰¤","á‰¥","á‰¦"],word:"á‰ áˆ­",sentence:"á‰ áˆ© á‰°áŠ¨áá‰·áˆ"},{base:"á‰°",orders:["á‰°","á‰±","á‰²","á‰³","á‰´","á‰µ","á‰¶"],word:"á‰°áˆ«áˆ«",sentence:"á‰°áˆ«áˆ«á‹ áŠ¨á á‹«áˆˆ áŠá‹"},{base:"á‰¸",orders:["á‰¸","á‰¹","á‰º","á‰»","á‰¼","á‰½","á‰¾"],word:"á‰¸áŠ®áˆŒá‰µ",sentence:"á‰¸áŠ®áˆŒT áŒ£á‹áŒ­ áŠá‹"},{base:"áŠ€",orders:["áŠ€","áŠ","áŠ‚","áŠƒ","áŠ„","áŠ…","áŠ†"],word:"áŠ€á‹­áˆ",sentence:"áŠ€á‹­áˆ á‹«áˆµáˆáˆáŒ‹áˆ"},{base:"áŠ",orders:["áŠ","áŠ‘","áŠ’","áŠ“","áŠ”","áŠ•","áŠ–"],word:"áŠá‰¥áˆ­",sentence:"áŠá‰¥áˆ­ áˆáŒ£áŠ• áŠá‹"},{base:"áŠ˜",orders:["áŠ˜","áŠ™","áŠš","áŠ›","áŠœ","áŠ","áŠ"],word:"áŠ˜áˆ‹áˆµá‰°áˆ­",sentence:"áŠ˜áˆ‹áˆµá‰°áˆ­ á‰áˆµáˆáŠ• á‹­áˆ¸ááŠ“áˆ"},{base:"áŠ ",orders:["áŠ ","áŠ¡","áŠ¢","áŠ£","áŠ¤","áŠ¥","áŠ¦"],word:"áŠ áŠ•á‰ áˆ³",sentence:"áŠ áŠ•á‰ áˆ³ á‹¨áŒ«áŠ« áŠ•áŒ‰áˆ¥ áŠá‹"},{base:"áŠ¨",orders:["áŠ¨","áŠ©","áŠª","áŠ«","áŠ¬","áŠ­","áŠ®"],word:"áŠ®áŠ¨á‰¥",sentence:"áŠ®áŠ¨á‰¥ á‰ áˆ°áˆ›á‹­ áˆ‹á‹­ á‹«á‰ áˆ«áˆ"},{base:"áŠ¸",orders:["áŠ¸","áŠ¹","áŠº","áŠ»","áŠ¼","áŠ½","áŠ¾"],word:"áŠ¸áˆšáˆµ",sentence:"áŠ¸áˆšáˆµ á‹¨áˆ³áˆáŠ•á‰± á‰€áŠ• áŠá‹"},{baseD:"á‹ˆ",orders:["á‹ˆ","á‹‰","á‹Š","á‹‹","á‹Œ","á‹","á‹"],word:"á‹ˆáŠ•á‰ áˆ­",sentence:"á‹ˆáŠ•á‰ áˆ© áˆá‰¹ áŠá‹"},{base:"á‹",orders:["á‹","á‹‘","á‹’","á‹“","á‹”","á‹•","á‹–"],word:"á‹“áˆ£",sentence:"á‹“áˆ£ á‰ á‹áˆƒ á‹áˆµáŒ¥ á‹­á‹‹áŠ›áˆ"},{base:"á‹˜",orders:["á‹˜","á‹™","á‹š","á‹›","á‹œ","á‹","á‹"],word:"á‹˜á‹­á‰µ",sentence:"á‹˜á‹­á‰µ áˆˆáˆáŒá‰¥ áˆ›á‰¥áˆ°á‹« á‹«áŒˆáˆˆáŒáˆ‹áˆ"},{base:"á‹ ",orders:["á‹ ","á‹¡","á‹¢","á‹£","á‹¤","á‹¥","á‹¦"],word:"á‰€áŒ­áŠ”",sentence:"á‰€áŒ­áŠ” áˆ¨áŒ…áˆ áŠ áŠ•áŒˆá‰µ áŠ áˆ‹á‰µ"},{base:"á‹¨",orders:["á‹¨","á‹©","á‹ª","á‹«","á‹¬","á‹­","á‹®"],word:"á‹¨áŒˆáŠ“ á‹›á",sentence:"á‹¨áŒˆáŠ“ á‹›á á‰ á‰ á‹“áˆ áŒŠá‹œ á‹«áŒŒáŒ£áˆ"},{base:"á‹°",orders:["á‹°","á‹±","á‹²","á‹³","á‹´","á‹µ","á‹¶"],word:"á‹°á‰¥á‰°áˆ­",sentence:"á‹°á‰¥á‰°áˆ© áˆˆáˆ˜áŒ»á áŠá‹"},{base:"áŒ€",orders:["áŒ€","áŒ","áŒ‚","áŒƒ","áŒ„","áŒ…","áŒ†"],word:"áŒ€áˆá‰£",sentence:"áŒ€áˆá‰£á‹ á‰ á‹áˆƒ áˆ‹á‹­ á‹­áŒ“á‹›áˆ"},{base:"áŒˆ",orders:["áŒˆ","áŒ‰","áŒŠ","áŒ‹","áŒŒ","áŒ","áŒ"],word:"áŒˆá‰ á‰³",sentence:"áŒˆá‰ á‰³á‹ á‰ áˆáŒá‰¥ á‹¨á‰°áˆáˆ‹ áŠá‹"},{base:"áŒ ",orders:["áŒ ","áŒ¡","áŒ¢","áŒ£","áŒ¤","áŒ¥","áŒ¦"],word:"áŒ áˆ¨áŒ´á‹›",sentence:"áŒ áˆ¨áŒ´á‹›á‹ áˆ‹á‹­ áˆ˜áŒ»áˆ•áá‰µ áŠ áˆ‰"},{base:"áŒ¨",orders:["áŒ¨","áŒ©","áŒª","áŒ«","áŒ¬","áŒ­","áŒ®"],word:"áŒ¨áˆ¨á‰ƒ",sentence:"áŒ¨áˆ¨á‰ƒ á‰ áˆŒáˆŠá‰µ á‰³á‰ áˆ«áˆˆá‰½"},{base:"áŒ°",orders:["áŒ°","áŒ±","áŒ²","áŒ³","áŒ´","áŒµ","áŒ¶"],word:"áŒ³áŒ³áˆµ",sentence:"áŒ³áŒ³áˆ± áŒ¸áˆá‰µ á‹­áˆ˜áˆ«áˆ‰"},{base:"áŒ¸",orders:["áŒ¸","áŒ¹","áŒº","áŒ»","áŒ¼","áŒ½","áŒ¾"],word:"áŒ¸áˆá‰µ",sentence:"áŒ¸áˆá‰µ áˆ°áˆ‹áˆáŠ• á‹«áˆ˜áŒ£áˆ"},{base:"á€",orders:["á€","á","á‚","áƒ","á„","á…","á†"],word:"á€áˆá‹­",sentence:"á€áˆá‹­ á‰¥áˆ­áˆƒáŠ• á‰µáˆ°áŒ£áˆˆá‰½"},{base:"áˆ",orders:["áˆ","á‰","áŠ","á‹","áŒ","á","á"],word:"áˆáˆ¨áˆµ",sentence:"áˆáˆ¨áˆµ á‰ ááŒ¥áŠá‰µ á‹­áˆ®áŒ£áˆ"},{base:"á",orders:["á","á‘","á’","á“","á”","á•","á–"],word:"á’á‹«áŠ–",sentence:"á’á‹«áŠ– áŒ£á‹áŒ­ á‹œáˆ› á‹«á‹ˆáŒ£áˆ"}];

    // ---------------- TTS API & Playback Logic (Fixed) ----------------
    // Includes robust error handling and backoff for the API calls.
    const audioPlayer = document.getElementById('audio-player');
    const statusBox = document.getElementById('status-box');
    const statusMessage = document.getElementById('status-message');
    let isSpeaking = false;

    // Helper to write a string to a DataView
    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }

    // Helper to convert Base64 string to ArrayBuffer for audio data processing
    function base64ToArrayBuffer(base64) {
        const binaryString = atob(base64);
        const len = binaryString.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
        }
        return bytes.buffer;
    }

    // Helper to wrap raw PCM audio data into a playable WAV blob
    function pcmToWav(pcm16, sampleRate) {
        const numChannels = 1;
        const bytesPerSample = 2;
        const blockAlign = numChannels * bytesPerSample;
        const byteRate = sampleRate * blockAlign;
        const dataLength = pcm16.length * bytesPerSample;

        const buffer = new ArrayBuffer(44 + dataLength);
        const view = new DataView(buffer);
        let offset = 0;

        // RIFF header
        writeString(view, offset, 'RIFF'); offset += 4;
        view.setUint32(offset, 36 + dataLength, true); offset += 4;
        writeString(view, offset, 'WAVE'); offset += 4;

        // FMT sub-chunk
        writeString(view, offset, 'fmt '); offset += 4;
        view.setUint32(offset, 16, true); offset += 4;          // Sub-chunk size (16 for PCM)
        view.setUint16(offset, 1, true); offset += 2;           // Audio format (1 for PCM)
        view.setUint16(offset, numChannels, true); offset += 2; // Number of channels
        view.setUint32(offset, sampleRate, true); offset += 4;  // Sample rate
        view.setUint32(offset, byteRate, true); offset += 4;    // Byte rate
        view.setUint16(offset, blockAlign, true); offset += 2;  // Block align
        view.setUint16(offset, 16, true); offset += 2;          // Bits per sample (16)

        // Data sub-chunk
        writeString(view, offset, 'data'); offset += 4;
        view.setUint32(offset, dataLength, true); offset += 4; // Data size

        // PCM data
        for (let i = 0; i < pcm16.length; i++) {
            view.setInt16(offset, pcm16[i], true);
            offset += 2;
        }

        return new Blob([view], { type: 'audio/wav' });
    }

    /** Displays a status message to the user. */
    function showStatus(message, isError = false) {
        statusMessage.textContent = message;
        statusBox.classList.remove('active'); // Remove and re-add to trigger transition/visibility
        statusBox.classList.add('active');
        statusBox.style.backgroundColor = isError ? '#ffeaea' : '#e0f7fa';
        statusBox.style.borderColor = isError ? '#ff0000' : '#00bcd4';
        statusBox.style.color = isError ? '#8b0000' : '#006064';
    }

    /** Hides the status message. */
    function hideStatus() {
        statusBox.classList.remove('active');
    }

    /**
     * Fetches audio data from the TTS API with exponential backoff.
     */
    async function fetchAudioWithBackoff(textToSpeak, retries = 0) {
        const MAX_RETRIES = 3;
        
        // ===================================================================
        // V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V V
        
        const apiKey = "AIzaSyBeVe45w7KtL5qt7IcfC3cUwk_Qr2OG-b4"; // <-- PASTE YOUR NEW API KEY HERE
        
        // ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^ ^
        // ===================================================================
        
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        if (!apiKey) {
            throw new Error("API Key is missing. Please add your API key to the script.");
        }

        const payload = {
            contents: [{ parts: [{ text: textToSpeak }] }],
            generationConfig: {
                responseModalities: ["AUDIO"],
                speechConfig: {
                    voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } }
                }
            },
            model: "gemini-2.5-flash-preview-tts"
        };

        const delay = Math.pow(2, retries) * 1000; // Exponential delay

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (response.status === 403) {
                throw new Error("403 Forbidden: TTS feature may be restricted in this environment.");
            }

            if (!response.ok) {
                throw new Error(`API call failed with status: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();
            const part = result?.candidates?.[0]?.content?.parts?.[0];
            const audioData = part?.inlineData?.data;
            const mimeType = part?.inlineData?.mimeType;

            if (!audioData || !mimeType) {
                throw new Error("API response was successful but did not contain valid audio data.");
            }

            return { audioData, mimeType };

        } catch (error) {
            console.error(`Attempt ${retries + 1} failed:`, error.message);
            if (retries < MAX_RETRIES) {
                showStatus(`TTS: Connection error, retrying in ${delay / 1000}s... (Attempt ${retries + 1}/${MAX_RETRIES})`);
                await new Promise(resolve => setTimeout(resolve, delay));
                return fetchAudioWithBackoff(textToSpeak, retries + 1);
            } else {
                throw new Error(`TTS Generation/Playback Error: Could not retrieve audio after ${MAX_RETRIES} attempts. Details: ${error.message}`);
            }
        }
    }


    /**
     * Generates and plays Amharic speech using the Gemini TTS API.
     * @param {string} text The Amharic text to speak.
     */
    async function speakAmharic(text) {
        if (isSpeaking) return;
        isSpeaking = true;

        showStatus(`Generating audio for "${text}"...`);

        try {
            // 1. Fetch the raw audio data
            const { audioData, mimeType } = await fetchAudioWithBackoff(text);

            // 2. Extract sample rate and convert PCM to WAV
            // The model is known to return 24000 Hz for this task
            const sampleRate = 24000;

            const pcmData = base64ToArrayBuffer(audioData);
            const pcm16 = new Int16Array(pcmData);
            const wavBlob = pcmToWav(pcm16, sampleRate);
            const audioUrl = URL.createObjectURL(wavBlob);

            // 3. Play the audio
            audioPlayer.src = audioUrl;

            audioPlayer.onended = () => {
                URL.revokeObjectURL(audioUrl);
                isSpeaking = false;
                hideStatus();
            };

            audioPlayer.onerror = (e) => {
                isSpeaking = false;
                URL.revokeObjectURL(audioUrl);
                showStatus("Playback failed. Please try again.", true);
            };

            await audioPlayer.play();
            showStatus(`Playing pronunciation for "${text}".`);

        } catch (error) {
            isSpeaking = false;
            console.error(error);
            let message = error.message;
            if (error.message.includes("403 Forbidden")) {
                message = "Error: TTS feature is currently unavailable or restricted. (403 Forbidden)";
            } else if (error.message.includes("API Key is missing")) {
                message = "Error: API Key is missing. Please add your new API key to the script.";
            }
            showStatus(message, true);
        }
    }


    // ---------------- Render Letters ----------------
    const lettersGrid = document.getElementById("lettersGrid");
    lettersData.forEach(l => {
        const c = document.createElement("div");
        c.className = "card";
        c.innerHTML = `<div class="base-letter" data-letter="${l.base}">${l.base}</div>
  <div class="orders">${l.orders.map(o => `<div class="order" data-letter="${o}">${o}</div>`).join('')}</div>
  <div class="word" data-letter="${l.word}">${l.word}</div>
  <div class="sentence">${l.sentence}</div>`;
        
        // This is the code that makes the words speak!
        c.addEventListener('click', (event) => {
            const targetLetter = event.target.dataset.letter;
            if (targetLetter) {
                speakAmharic(targetLetter);
            }
        });
        lettersGrid.appendChild(c);
    });

    // ---------------- Navigation ----------------
    document.querySelectorAll('nav button').forEach(btn=>{
        btn.addEventListener('click',()=>{
            document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.getElementById(btn.dataset.section).classList.add('active');
        });
    });

    // ---------------- Toggles ----------------
    document.getElementById("contrastBtn").addEventListener("click",()=>document.body.classList.toggle("high-contrast"));
    document.getElementById("textBtn").addEventListener("click",()=>document.body.classList.toggle("large-text"));


    // ---------------- Quiz ----------------
    const quizArea = document.getElementById("quizArea");
    const emojiFeedback = document.getElementById("emojiFeedback");
    let score = 0;

    function generateQuiz(){
        const q = lettersData[Math.floor(Math.random()*lettersData.length)];
        quizArea.innerHTML=`<p>Click the letter for the word: <strong>${q.word}</strong></p>
  ${lettersData.map(l => `<button class="option-btn" data-letter="${l.base}" onclick="checkAnswer(this, '${q.base}', '${q.word}')">${l.base}</button>`).join('')}`;
    }

    function checkAnswer(btn, correctAnswer, word) {
        if (btn.dataset.letter === correctAnswer) {
            speakAmharic(word);
            btn.classList.add("correct");
            showFireworks();
            emojiFeedback.innerText="ğŸ‰ áŒá‰ á‹!";
            score++;
            document.getElementById("score").innerText = score;
            const popup = document.getElementById('word-popup');
            popup.textContent = word;
            popup.classList.remove('hidden');
            setTimeout(() => {
                popup.classList.add('hidden');
            }, 3000);
            setTimeout(() => {
                emojiFeedback.innerText = "";
                generateQuiz();
            }, 4000);
        } else {
            console.warn("Incorrect answer.");
            btn.classList.add("wrong");
            emojiFeedback.innerText = "âŒ áŠ¥áŠ•á‹°áŒˆáŠ“ áˆáŠ­áˆ­!";
            setTimeout(() => {
                btn.classList.remove("wrong");
                emojiFeedback.innerText = "";
            }, 3000);
        }
    }

    // Initialize the quiz on load
    window.onload = generateQuiz;

    // ---------------- Fireworks ----------------
    const canvas=document.getElementById("effectsCanvas");
    const ctx=canvas.getContext("2d");
    canvas.width=window.innerWidth;
    canvas.height=window.innerHeight;

    function showFireworks(){
        for(let i=0;i<50;i++){
            const x=Math.random()*canvas.width;
            const y=Math.random()*canvas.height/2;
            ctx.fillStyle=`hsl(${Math.random()*360},100%,50%)`;
            ctx.beginPath();
            ctx.arc(x,y,Math.random()*8+2,0,Math.PI*2);
            ctx.fill();
        }
        setTimeout(()=>ctx.clearRect(0,0,canvas.width,canvas.height),500);
    }
    window.addEventListener('resize',()=>{canvas.width=window.innerWidth; canvas.height=window.innerHeight;});

    // ---------------- Mini Games ----------------
    const gameArea = document.getElementById("gameArea");

    function startMatchingGame() {
        gameArea.innerHTML = `<h3>ğŸ§  Find the Matching Letters!</h3><div class="memory-game-board" id="memory-board"></div><button class="game-btn" onclick="startMatchingGame()">Reset Game</button>`;
        const memoryBoard = document.getElementById('memory-board');
        const gameLetters = lettersData.map(l => l.base).sort(() => 0.5 - Math.random()).slice(0, 8);
        const cardSet = [...gameLetters, ...gameLetters];
        cardSet.sort(() => Math.random() - 0.5);
        let hasFlippedCard = false;
        let lockBoard = false;
        let firstCard, secondCard;
        cardSet.forEach(letter => {
            const card = document.createElement('div');
            card.classList.add('memory-card');
            card.dataset.letter = letter;
            card.innerHTML = `
      <div class="front-face"></div>
      <div class="back-face">${letter}</div>
    `;
            memoryBoard.appendChild(card);
            card.addEventListener('click', flipCard);
        });
        function flipCard() {
            if (lockBoard) return;
            if (this === firstCard) return;
            this.classList.add('flipped');
            speakAmharic(this.dataset.letter); // Use the fixed TTS function
            if (!hasFlippedCard) {
                hasFlippedCard = true;
                firstCard = this;
                return;
            }
            secondCard = this;
            checkForMatch();
        }
        function checkForMatch() {
            let isMatch = firstCard.dataset.letter === secondCard.dataset.letter;
            isMatch ? disableCards() : unflipCards();
        }
        function disableCards() {
            firstCard.removeEventListener('click', flipCard);
            secondCard.removeEventListener('click', flipCard);
            showFireworks();
            resetBoard();
        }
        function unflipCards() {
            lockBoard = true;
            setTimeout(() => {
                firstCard.classList.remove('flipped');
                secondCard.classList.remove('flipped');
                resetBoard();
            }, 1200);
        }
        function resetBoard() {
            [hasFlippedCard, lockBoard] = [false, false];
            [firstCard, secondCard] = [null, null];
        }
    }

    function startTraceGame() {
        gameArea.innerHTML = `<h3>âœï¸ Trace the Letter</h3>
    <p>This is a placeholder for a tracing game. Click the letter to hear its sound.</p>
    <div style="font-size:60px;cursor:pointer; padding: 20px; border: 2px dashed var(--accent); border-radius: 10px; display: inline-block;" onclick="speakAmharic('áˆ€')">áˆ€</div>`;
    }
</script>
</body>
</html>
